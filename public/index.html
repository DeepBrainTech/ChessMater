<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ChessMater</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      margin: 0;
      padding: 20px;
      color: #333;
      min-height: 100vh;
    }
    .container {
      max-width: 1300px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    .current-user-name {
      text-align: center;
      color: #7f8c8d;
      font-size: 0.95rem;
      margin: -10px 0 15px 0;
      min-height: 1.2em;
    }
    .game-area {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      border: 3px solid #2c3e50;
      border-radius: 5px;
      background: #f4f4f4;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    #controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      padding: 15px;
      background: #ecf0f1;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      flex-wrap: wrap;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #2c3e50;
    }
    select, button {
      padding: 8px 15px;
      border: 2px solid #3498db;
      border-radius: 5px;
      background: white;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    select:hover, button:hover {
      background: #f8f9fa;
      border-color: #2980b9;
    }
    button {
      background: #3498db;
      color: white;
      font-weight: bold;
    }
    button:hover {
      background: #2980b9;
    }
    .instructions {
      margin-top: 25px;
      padding: 15px;
      background: #d4e6f1;
      border-radius: 8px;
      line-height: 1.6;
    }
    .instructions h3 {
      color: #2c3e50;
      margin-top: 0;
    }
    footer {
      text-align: center;
      margin-top: 30px;
      font-size: 14px;
      color: #7f8c8d;
    }
    a {
      color: #3498db;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .status {
      margin-top: 15px;
      font-weight: bold;
      text-align: center;
      min-height: 24px;
      color: #2c3e50;
    }
    .player-count {
      margin-top: 10px;
      text-align: center;
    }
    .download-section {
      margin-top: 20px;
      text-align: center;
    }
    #puzzleName {
      padding: 8px 15px;
      border: 2px solid #3498db;
      border-radius: 5px;
      font-size: 16px;
      margin-right: 10px;
      width: 200px;
    }
    .save-notice {
      margin-top: 10px;
      padding: 10px;
      background: #d5f5e3;
      border-radius: 5px;
      font-size: 14px;
      display: none;
    }
    .danger-zone {
      margin-top: 20px;
      padding: 15px;
      background: #ffecb3;
      border-radius: 8px;
      text-align: center;
    }
    .danger-zone button {
      background: #e74c3c;
    }
    .danger-zone button:hover {
      background: #c0392b;
    }
    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }

    .confetti {
      position: absolute;
      pointer-events: none;
      z-index: 1000;
    }

    #modeToggle {
      display: none !important;
    }

    /* Confetti animations */
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    @keyframes confetti-spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes confetti-wiggle {
      0%, 100% {
        transform: translateX(0px);
      }
      50% {
        transform: translateX(10px);
      }
    }
    
    /* Level selection styles */
    .level-selector {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      width: 100%;
      max-width: 800px;
    }
    
    .level-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .level-button {
      padding: 10px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    
    .level-button:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }
    
    .level-button.completed {
      background: #2ecc71;
    }
    
    .mode-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #2c3e50;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 10;
    }
    
    .portal-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #f5f5f5;
      color: #333;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      display: inline-block;
      transition: all 0.3s ease;
    }
    
    .portal-button:hover {
      background: #e8e8e8;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }
    
    .portal-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    
    .developer-only {
      display: none;
    }
    
    .consumer-mode .developer-only {
      display: none !important;
    }
    
    .developer-mode .developer-only {
      display: block;
    }
    
    .consumer-mode #controls {
      justify-content: center;
    }
    
    .consumer-mode .level-selector {
      display: block;
    }
    
    .developer-mode .level-selector {
      display: none;
    }

    .start-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(120deg, #1e3c72, #2a5298, #e52d27, #ff6e00);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: #fff;
    }

    .start-screen h1 {
      font-size: 3rem;
      margin-bottom: 20px;
      text-shadow: 2px 2px 5px #000;
    }

    #startButton {
      padding: 12px 24px;
      font-size: 1.2rem;
      font-weight: bold;
      background-color: #1da1f2;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
    }

    #startButton:hover {
      background-color: #0d8ddb;
    }

    .start-screen-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
    }

    #leaderboardButton {
      padding: 12px 24px;
      font-size: 1.2rem;
      font-weight: bold;
      background-color: #9b59b6;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
    }

    #leaderboardButton:hover {
      background-color: #8e44ad;
    }

    #loginPrompt {
      margin-top: 12px;
      padding: 10px 16px;
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid #e74c3c;
      border-radius: 8px;
      color: #fff;
      font-size: 0.95rem;
      text-align: center;
    }
    #loginPrompt a {
      color: #f1c40f;
      text-decoration: underline;
      margin-left: 6px;
    }
    #loginPrompt a:hover {
      color: #f39c12;
    }

    .leaderboard-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10001;
      justify-content: center;
      align-items: center;
    }

    .leaderboard-modal.active {
      display: flex;
    }

    .leaderboard-content {
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      color: #fff;
    }

    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .leaderboard-header h2 {
      margin: 0;
      font-size: 2rem;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .close-leaderboard {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s;
    }

    .close-leaderboard:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }

    .leaderboard-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }

    .leaderboard-rank {
      font-size: 1.5rem;
      font-weight: bold;
      min-width: 50px;
    }

    .leaderboard-rank.gold {
      color: #ffd700;
    }

    .leaderboard-rank.silver {
      color: #c0c0c0;
    }

    .leaderboard-rank.bronze {
      color: #cd7f32;
    }

    .leaderboard-user {
      flex: 1;
      margin-left: 15px;
      font-size: 1.1rem;
    }

    .leaderboard-score {
      font-size: 1.2rem;
      font-weight: bold;
      min-width: 80px;
      text-align: right;
    }

    .leaderboard-loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
    }

    .leaderboard-error {
      text-align: center;
      padding: 40px;
      color: #ff6b6b;
      font-size: 1.1rem;
    }

    .canvas-container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      overflow: hidden; /* <--- Fix */
    }

    canvas {
      width: 100%;
      height: auto;
      max-width: 100%;
      display: block;
    }

    #rotateNotice {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      background: #e74c3c;
      color: white;
      width: 100%;
      padding: 12px;
      text-align: center;
      font-weight: bold;
      z-index: 10000;
    }
    #blockDescriptionBox {
      max-width: 220px;
      width: 100%;
      overflow-wrap: break-word;
      flex-shrink: 0;
    }

    /* --- MOBILE LAYOUT --- */
    @media screen and (max-width: 900px) {
      /* 1. Force Vertical Layout (Stack Canvas & Tip Box) */
      .game-area > div[style*="display: flex"] {
        flex-direction: column !important;
        align-items: center !important;
        gap: 10px !important;
        width: 100%;
      }

      /* 2. Center and resize the Canvas */
      .canvas-container {
        width: 100% !important;
        display: flex;
        justify-content: center;
        margin: 0 auto;
        min-width: 0 !important;
      }
      
      canvas {
        width: 100% !important;       /* Fits perfectly inside the container */
        max-width: 100% !important;   /* Prevents it from growing too large */
        height: auto !important;
        display: block;
      }

      /* 3. Fix "Block Tip" Visibility */
      #blockDescriptionBox {
        position: static !important; /* Don't float */
        width: 90% !important;
        margin: 10px auto !important;
        background: rgba(255, 255, 255, 0.95) !important; /* Opaque white background */
        color: #333 !important; /* Dark text */
        padding: 15px !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3) !important;
        display: block !important;
        max-width: 90vw !important;
      }
      
      /* Ensure header and text inside are readable */
      #blockDescriptionBox h3, 
      #blockDescriptionBox p {
        color: #333 !important;
        margin: 5px 0 !important;
        text-shadow: none !important;
      }

      /* 4. Move Floating Buttons UP to avoid browser bar */
      #restartLevelBtn, 
      #musicToggle, 
      button[onclick="toggleAntigravity()"] {
        position: fixed !important;
        bottom: 10px !important;
        z-index: 10000 !important;
        /* Make buttons smaller to fit side-by-side */
        font-size: 0.8rem !important; 
        padding: 8px 10px !important;
        min-height: 40px !important; /* Override the big button size */
        width: auto !important; /* Let them shrink to fit text */
        box-shadow: 0 4px 10px rgba(0,0,0,0.4) !important;
      }

      /* 5. Separate the buttons horizontally so they don't overlap */
      button[onclick="toggleAntigravity()"] {
        left: 10px !important;
        width: 30% !important; /* Assign explicit width shares */
      }
      
      #musicToggle {
        right: 10px !important;
        left: auto !important;
        width: 25% !important;
      }
      
      #restartLevelBtn {
        left: 50% !important;
        transform: translateX(-50%) !important;
        width: 30% !important;
        right: auto !important;
      }

      /* 6. Add extra padding to bottom of page so buttons don't cover levels */
      body {
        padding-bottom: 120px !important;
      }

      body::after {
        content: "";
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 70px; /* Height of the button area */
        background: rgba(26, 42, 108, 0.95); /* Dark Blue to match theme */
        border-top: 1px solid rgba(255,255,255,0.2);
        z-index: 9999; /* Just behind the buttons */
        pointer-events: none; /* Let clicks pass through if needed */
      }

      /* Portal button mobile styles */
      .portal-button {
        top: 10px !important;
        left: 10px !important;
        padding: 8px 16px !important;
        font-size: 12px !important;
      }

      /* Leaderboard mobile styles */
      .leaderboard-content {
        padding: 20px !important;
        max-width: 95% !important;
      }

      .leaderboard-header h2 {
        font-size: 1.5rem !important;
      }

      .leaderboard-item {
        padding: 12px !important;
        font-size: 0.9rem !important;
      }

      .leaderboard-rank {
        font-size: 1.2rem !important;
        min-width: 40px !important;
      }

      .leaderboard-user {
        font-size: 1rem !important;
      }

      .leaderboard-score {
        font-size: 1rem !important;
        min-width: 60px !important;
      }

      .start-screen-buttons {
        gap: 12px !important;
      }

      #startButton, #leaderboardButton {
        padding: 10px 20px !important;
        font-size: 1rem !important;
      }
    }



  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body class="consumer-mode">
  <button id="portalButton" class="portal-button">
    Back to Main Portal
  </button>
  <div id="rotateNotice">
    üîÑ Please rotate your device to landscape for the best experience!
  </div>
  <script>
    // Parse URL hash params
    function getHashParams() {
      const hash = window.location.hash.substring(1);
      const params = {};
      hash.split('&').forEach(param => {
        const [key, value] = param.split('=');
        if (key && value) {
          params[key] = decodeURIComponent(value);
        }
      });
      return params;
    }

    // Get token and locale from URL hash
    const hashParams = getHashParams();
    const gameToken = hashParams.token || null;
    const locale = hashParams.locale || 'en';

    // If new token in URL, clear old local data (QuantumGo-style)
    if (gameToken) {
      localStorage.removeItem("access_token");
      localStorage.removeItem("userId");
      localStorage.removeItem("user_name");
      localStorage.removeItem("user_password");
      localStorage.removeItem("sso_token");
    }

    // Save locale to localStorage
    if (locale) {
      localStorage.setItem("cm_locale", locale);
    }

    // ‰ªÖ‰ΩøÁî®‰∏ªÁ´ô URL Â∏¶Êù•ÁöÑ tokenÔºå‰ºöËØùÂÜÖÁî® window ‰øùÂ≠òÔºå‰∏ç‰ΩøÁî® localStorage
    window.cmToken = null;
    window.cmUser = null;
    let user = null;
    if (gameToken) {
      try {
        const payload = gameToken.split(".")[1];
        user = JSON.parse(atob(payload));
        console.log("ChessMater user:", user);
        console.log("Locale:", locale);

        window.authReady = fetch('https://chessmater-production.up.railway.app/api/auth/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${gameToken}`
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('User verified:', data);
            window.cmToken = gameToken;
            window.cmUser = data.user;
            updateCurrentUserName();
            if (typeof window.updateLoginPromptVisibility === 'function') window.updateLoginPromptVisibility();
          } else {
            console.error('Token verification failed:', data.message);
            window.cmToken = gameToken;
            window.cmUser = user ? { id: user.sub, username: user.username, portal_user_id: user.user_id } : null;
            updateCurrentUserName();
            if (typeof window.updateLoginPromptVisibility === 'function') window.updateLoginPromptVisibility();
          }
          history.replaceState(null, null, window.location.pathname + window.location.search);
          return data;
        })
        .catch(err => {
          console.error('Token verify request failed:', err);
          window.cmToken = gameToken;
          window.cmUser = user ? { id: user.sub, username: user.username, portal_user_id: user.user_id } : null;
          updateCurrentUserName();
          if (typeof window.updateLoginPromptVisibility === 'function') window.updateLoginPromptVisibility();
          history.replaceState(null, null, window.location.pathname + window.location.search);
        });
      } catch (err) {
        console.error("JWT parse error:", err);
        window.authReady = Promise.resolve();
      }
    } else {
      window.authReady = Promise.resolve();
    }

    function updateCurrentUserName() {
      const el1 = document.getElementById("startScreenUserName");
      const el2 = document.getElementById("mainContainerUserName");
      if (!el1 && !el2) return;
      const u = window.cmUser;
      const text = u ? (u.username || u.user_id || (u.portal_user_id ? String(u.portal_user_id) : "") || "") : "";
      const display = text ? "current user: " + text : "";
      if (el1) el1.textContent = display;
      if (el2) el2.textContent = display;
    }
    document.addEventListener("DOMContentLoaded", updateCurrentUserName);
  </script>
  <button class="mode-toggle" id="modeToggle">Switch to Consumer Mode</button>

  <div id="startScreen" class="start-screen">
    <h1>ChessMater</h1>
    <p id="startScreenUserName" class="current-user-name"></p>
    <p id="loginPrompt" class="login-prompt" style="display: none;">Please log in to play. <a href="https://game.deepbraintechnology.com/" target="_blank">Go to main portal to log in</a></p>
    <div class="start-screen-buttons">
      <button id="startButton">Start Game</button>
      <button id="leaderboardButton">üèÜ Leaderboard</button>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div id="leaderboardModal" class="leaderboard-modal">
    <div class="leaderboard-content">
      <div class="leaderboard-header">
        <h2>üèÜ Leaderboard</h2>
        <button class="close-leaderboard" id="closeLeaderboard">&times;</button>
      </div>
      <div id="leaderboardList">
        <div class="leaderboard-loading">Loading leaderboard...</div>
      </div>
    </div>
  </div>
  
  <div class="container consumer-mode" id="mainContainer">
    <h1>ChessMater</h1>
    <p id="mainContainerUserName" class="current-user-name"></p>
    <div class="game-area">
      <div style="display: flex; gap: 20px;">
        <div class="canvas-container">
          <canvas id="gameCanvas" width="1280" height="800"></canvas>
        </div>
      
        <div style="display:flex;flex-direction:column;gap:4px;">
          <button type="button" id="blockTipToggle" class="control-group" style="align-self:flex-start;">Block Tip</button>
          <div id="blockDescriptionBox" class="hidden">
          <h3>Block Tip</h3>
          <p id="blockDescription">Welcome! Start the first level to learn about blocks.</p>
          </div>
        </div>
      </div>
      
      <div id="controls">
        <div class="control-group developer-only">
          <label>Mode:</label>
          <select id="modeSelect">
            <option value="edit">Edit Mode</option>
            <option value="play">Play Mode</option>
          </select>
        </div>
        
        <div class="control-group developer-only">
          <label>Edit Tool:</label>
          <select id="editMode">
            <option value="player_rook">Rook</option>
            <option value="player_bishop">Bishop</option>
            <option value="player_queen">Queen</option>
            <option value="player_knight">Knight</option>
            <option value="player_king">King</option>
            <option value="player_pawn">Pawn</option>
            <option value="goal">Goal</option>
            <option value="counter_goal">Counter Goal</option>
            <option value="block">Solid Block</option>
            <option value="phase_block">Phase Block</option>
            <option value="transformer">Transformer Block</option>
            <option value="objective">Objective Block</option>
            <option value="teleport_purple">Purple Teleporter</option>
            <option value="teleport_green">Green Teleporter</option>
            <option value="teleport_blue">Blue Teleporter</option>
            <option value="teleport_orange">Orange Teleporter</option>
            <option value="bomb">Bomb Block</option>
            <option value="erase">Erase</option>
          </select>
        </div>

        <div class="control-group developer-only">
          <label>Board Size:</label>
          <select id="boardSize">
            <option value="10x16">10x16 (Default)</option>
            <option value="8x8">8x8 (Chess Board)</option>
            <option value="12x20">12x20 (Large)</option>
            <option value="6x10">6x10 (Small)</option>
            <option value="custom">Custom...</option>
          </select>
        </div>

        <!-- <div class="control-group">
          <label>Visibility:</label>
          <select id="visibilityMode">
            <option value="classic">Classic</option>
            <option value="fog">Fog of War</option>
          </select>
        </div> -->

        <div style="margin-top: 20px; text-align: center;">
          <button id="nextLevelBtn" style="display: none;">Next Level ‚û°Ô∏è</button>
        </div>

        <div id="customSizeInputs" class="developer-only" style="display: none; margin-top: 10px;">
          <input type="number" id="customRows" placeholder="Rows" min="4" max="20" value="10">
          <span>x</span>
          <input type="number" id="customCols" placeholder="Columns" min="4" max="30" value="16">
          <button id="applyCustomSize">Apply</button>
        </div>
        
        <div class="control-group developer-only" id="counterGoalSettings" style="display:none;">
          <label>Counter Goal Moves:</label>
          <input type="number" id="counterGoalMoves" value="5" min="1" max="99">
        </div>
      </div>
      
      <div class="download-section developer-only">
        <input type="text" id="puzzleName" placeholder="Puzzle Name">
        <button id="downloadBtn">Save Puzzle to Levels Folder</button>
        <div class="save-notice" id="saveNotice">
          Puzzle saved to levels folder! The file will be downloaded automatically.
        </div>
      </div>
      
      <div class="danger-zone developer-only">
        <button id="eraseBoardBtn">Erase Entire Board</button>
        <p>Warning: This will clear everything from the board!</p>
      </div>
      
      <div class="level-selector">
        <h3>Select a Level</h3>
        <div class="level-grid" id="levelGrid">
          <!-- Levels will be populated by JavaScript -->
        </div>
      </div>
      
      <div class="player-count" id="playerCount">Players: 0</div>
      <div class="objective-count" id="objectiveCount">Objectives: 0/0</div>
      <div class="status" id="statusMessage"></div>
      
      <!-- <div class="instructions">
        <h3>How to Use:</h3>
        <p><strong>Edit Mode:</strong> Use the tools to place player pieces (your chess pieces), goal (red king), and blocks (green squares).</p>
        <p><strong>Play Mode:</strong> Click on a valid destination to move your pieces according to chess rules.</p>
        <p><strong>Gravity:</strong> Pieces will fall to the bottom or onto blocks/other players. Use the "Apply Gravity" button or they'll fall automatically in play mode.</p>
        <p><strong>Player Stacking:</strong> Players can land on top of other players, treating them like blocks.</p>
        <p><strong>Save Puzzle:</strong> Enter a name and click "Save Puzzle" to automatically save to the levels folder.</p>
        <p><strong>Winning:</strong> Only one player needs to reach the goal to win!</p>
      </div> -->
    </div>
    
    <footer>
      Chess piece images by <a href="https://en.wikipedia.org/wiki/User:Cburnett">Cburnett</a>, 
      licensed under <a href="https://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0</a>. 
      Source: <a href="https://commons.wikimedia.org/wiki/Category:SVG_chess_pieces">Wikimedia Commons</a>.
    </footer>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const bgMusic = document.getElementById("bgMusic");
      const musicToggle = document.getElementById("musicToggle");
      const startButton = document.getElementById("startButton");
      let musicPlaying = false;

      // üéÆ Start the music when the Start button is clicked
      if (startButton) {
        startButton.addEventListener("click", () => {
          if (!musicPlaying) {
            bgMusic.volume = 0.5; // Optional: softer background
            bgMusic.play().catch(err => console.warn("Autoplay blocked:", err));
            musicPlaying = true;
            musicToggle.textContent = "üîä Music";
          }
        });
      }

      // üéöÔ∏è Toggle music on/off
      musicToggle.addEventListener("click", () => {
        if (bgMusic.paused) {
          bgMusic.play();
          musicToggle.textContent = "üîä Music";
          musicPlaying = true;
        } else {
          bgMusic.pause();
          musicToggle.textContent = "üîá Muted";
          musicPlaying = false;
        }
      });
    });

    document.addEventListener("DOMContentLoaded", () => {
      const restartBtn = document.getElementById("restartLevelBtn");

      if (restartBtn) {
        restartBtn.addEventListener("click", () => {
          if (typeof restartLevel === "function") {
            restartLevel();
          } else {
            console.error("restartLevel() not found");
          }
        });
      }

      // Leaderboard functionality
      const leaderboardButton = document.getElementById("leaderboardButton");
      const leaderboardModal = document.getElementById("leaderboardModal");
      const closeLeaderboard = document.getElementById("closeLeaderboard");
      const leaderboardList = document.getElementById("leaderboardList");

      if (leaderboardButton) {
        leaderboardButton.addEventListener("click", () => {
          if (!isLoggedIn()) {
            alert("Please log in to view the leaderboard");
            return;
          }
          leaderboardModal.classList.add("active");
          loadLeaderboard();
        });
      }

      if (closeLeaderboard) {
        closeLeaderboard.addEventListener("click", () => {
          leaderboardModal.classList.remove("active");
        });
      }

      // Close modal when clicking outside
      if (leaderboardModal) {
        leaderboardModal.addEventListener("click", (e) => {
          if (e.target === leaderboardModal) {
            leaderboardModal.classList.remove("active");
          }
        });
      }

      // Load leaderboard data
      async function loadLeaderboard() {
        if (!leaderboardList) return;
        leaderboardList.innerHTML = '<div class="leaderboard-loading">Loading leaderboard...</div>';
        await (window.authReady || Promise.resolve());
        try {
          const token = window.cmToken;
          const res = await fetch("https://chessmater-production.up.railway.app/leaderboard", {
            credentials: 'include',
            headers: { Authorization: token ? `Bearer ${token}` : '' },
          });

          if (res.status === 401) {
            window.cmToken = null;
            window.cmUser = null;
            leaderboardList.innerHTML = '<div class="leaderboard-error">Session expired. Please <a href="https://game.deepbraintechnology.com/" target="_blank">log in again</a> from the portal.</div>';
            return;
          }
          if (!res.ok) {
            throw new Error("Failed to fetch leaderboard");
          }

          const data = await res.json();
          displayLeaderboard(data);
        } catch (err) {
          console.error("Error loading leaderboard:", err);
          leaderboardList.innerHTML = '<div class="leaderboard-error">Failed to load leaderboard. Please try again later.</div>';
        }
      }

      function displayLeaderboard(leaderboardData) {
        if (!leaderboardData || !Array.isArray(leaderboardData) || leaderboardData.length === 0) {
          leaderboardList.innerHTML = '<div class="leaderboard-loading">No leaderboard data available yet.</div>';
          return;
        }

        const currentUserId = window.cmUser ? (window.cmUser.user_id || window.cmUser.portal_user_id || window.cmUser.id) : null;
        const html = leaderboardData.map((entry, index) => {
          const rank = index + 1;
          let rankClass = "";
          if (rank === 1) rankClass = "gold";
          else if (rank === 2) rankClass = "silver";
          else if (rank === 3) rankClass = "bronze";

          const isCurrentUser = entry.user_id === currentUserId;
          // Format user_id to be more readable (show first 8 chars)
          const userId = entry.user_id || "";
          const displayName = entry.username || (userId.length > 8 ? userId.substring(0, 8) + "..." : userId) || "Anonymous";
          
          return `
            <div class="leaderboard-item" ${isCurrentUser ? 'style="background: rgba(255,255,255,0.2); border: 2px solid #ffd700;"' : ''}>
              <span class="leaderboard-rank ${rankClass}">${rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank}</span>
              <span class="leaderboard-user">${displayName}${isCurrentUser ? ' (You)' : ''}</span>
              <span class="leaderboard-score">Level ${entry.max_unlocked || 0}</span>
            </div>
          `;
        }).join("");

        leaderboardList.innerHTML = `<ul class="leaderboard-list">${html}</ul>`;
      }
    });

    // Mode management
    let isDeveloperMode = true;
    
    // Predefined levels (in a real app, these would be loaded from files)
    const predefinedLevels = [
      { name: "Level 1", file: "levels/level1.json" },
      { name: "Level 2", file: "levels/level2.json" },
      { name: "Level 3", file: "levels/level3.json" }
      // { name: "Level 4", file: "levels/level4.json" },
      // { name: "Level 5", file: "levels/level5.json" },
      // { name: "Level 6", file: "levels/level6.json" },
      // { name: "Level 7", file: "levels/level7.json" },
      // { name: "Level 8", file: "levels/level8.json" },
      // { name: "Level 9", file: "levels/level9.json" },
      // { name: "Level 10", file: "levels/level10.json" }
    ];
    
    // Toggle between developer and consumer mode (guard for missing element)
    const modeToggleEl = document.getElementById('modeToggle');
    if (modeToggleEl) {
      modeToggleEl.addEventListener('click', function() {
        isDeveloperMode = !isDeveloperMode;
        const container = document.getElementById('mainContainer');
        const toggleButton = document.getElementById('modeToggle');
        if (!container || !toggleButton) return;
        if (isDeveloperMode) {
          container.classList.remove('consumer-mode');
          container.classList.add('developer-mode');
          toggleButton.textContent = 'Switch to Consumer Mode';
          const modeSelect = document.getElementById('modeSelect');
          if (modeSelect) modeSelect.value = 'edit';
          mode = 'edit';
          updateStatus('Developer Mode: Full editing capabilities enabled');
        } else {
          container.classList.remove('developer-mode');
          container.classList.add('consumer-mode');
          toggleButton.textContent = 'Switch to Developer Mode';
          const modeSelect = document.getElementById('modeSelect');
          if (modeSelect) modeSelect.value = 'play';
          mode = 'play';
          updateStatus('Consumer Mode: Level selection enabled');

          // üü¢ Load levels from levels.js when entering consumer mode
          loadLevels();
        }
      });
    }

    async function fetchProgress() {
      try {
        await (window.authReady || Promise.resolve());
        const token = window.cmToken;
        if (!token) {
          return parseInt(localStorage.getItem("cm_maxUnlocked") || "1", 10);
        }
        const res = await fetch("https://chessmater-production.up.railway.app/progress", {
          credentials: 'include',
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error("‚ùå Failed to fetch progress:", res.status, errorText);
          if (res.status === 401) {
            window.cmToken = null;
            window.cmUser = null;
          }
          return parseInt(localStorage.getItem("cm_maxUnlocked") || "1", 10);
        }

        const data = await res.json();
        const maxUnlocked = parseInt(data.maxUnlocked || "1", 10);
        console.log("‚úÖ Fetched maxUnlocked:", maxUnlocked);
        localStorage.setItem("cm_maxUnlocked", maxUnlocked.toString());
        return maxUnlocked;

      } catch (err) {
        console.warn("‚ö†Ô∏è Error in fetchProgress:", err);
        return parseInt(localStorage.getItem("cm_maxUnlocked") || "1", 10);
      }
    }

    
    // Load and display levels. Optional maxUnlocked avoids refetch when caller already has it (e.g. after winning).
    async function loadLevels(optionalMaxUnlocked) {
      const levelGrid = document.getElementById("levelGrid");
      if (!levelGrid) return;
      levelGrid.innerHTML = "";

      const maxUnlocked = optionalMaxUnlocked != null ? optionalMaxUnlocked : await fetchProgress();


      LEVELS.forEach((level, index) => {
        const button = document.createElement("button");

        // Determine lock state
        const isLocked = index + 1 > maxUnlocked;

        button.className = "level-button";
        button.textContent = level.name || `Level ${index + 1}`;

        if (isLocked) {
            button.style.background = "#777";
            button.style.cursor = "not-allowed";
            button.style.opacity = "0.5";
            button.textContent += " üîí";

            // Prevent clicking locked levels
            button.addEventListener("click", () => {
                updateStatus("This level is locked. Complete earlier levels first!");
            });
        } else {
            // Level is playable
            button.addEventListener("click", () => {
                currentLevelIndex = index;
                // Hide start screen when loading a level
                const startScreen = document.getElementById("startScreen");
                if (startScreen) {
                    startScreen.style.display = "none";
                    updatePortalButton(); // Update button state
                }
                loadPuzzle(level);
            });
        }

        levelGrid.appendChild(button);
      });
    }


    
    // Load a single level into the game
    function loadLevel(level) {
      // Deep copy to avoid editing the original level definition
      board = JSON.parse(JSON.stringify(level.board));
      players = JSON.parse(JSON.stringify(level.players));
      goal = JSON.parse(JSON.stringify(level.goal));
      
      drawBoard();
    }
    
    function isLoggedIn() {
      return !!(window.cmToken && window.cmUser);
    }
    function updateLoginPromptVisibility() {
      const el = document.getElementById("loginPrompt");
      if (el) el.style.display = isLoggedIn() ? "none" : "block";
    }
    window.updateLoginPromptVisibility = updateLoginPromptVisibility;

    document.addEventListener("DOMContentLoaded", () => {
    updateLoginPromptVisibility();
    // Load level buttons
    loadLevels();

    // Set to Play Mode
    const modeSelect = document.getElementById("modeSelect");
    if (modeSelect) {
        modeSelect.value = "play";
        modeSelect.dispatchEvent(new Event("change"));
    }

    // Portal Button Logic - Update based on start-screen visibility
    function updatePortalButton() {
      const portalButton = document.getElementById("portalButton");
      const startScreen = document.getElementById("startScreen");
      
      if (!portalButton || !startScreen) return;
      
      // Check if start-screen is visible
      const computedStyle = window.getComputedStyle(startScreen);
      const isStartScreenVisible = computedStyle.display !== "none";
      
      if (isStartScreenVisible) {
        // On home page: show "Back to Main Portal" and link to external site
        portalButton.textContent = "Back to Main Portal";
        portalButton.onclick = () => {
          window.open("https://game.deepbraintechnology.com/", "_blank");
        };
      } else {
        // In game: show "Back to Home" and return to start screen
        portalButton.textContent = "Back to Home";
        portalButton.onclick = () => {
          const startScreen = document.getElementById("startScreen");
          if (startScreen) {
            startScreen.style.display = "flex";
            updatePortalButton(); // Update button state
          }
        };
      }
    }

    // Initialize portal button state
    updatePortalButton();

    // Monitor start-screen visibility changes
    const startScreenObserver = new MutationObserver(() => {
      updatePortalButton();
    });
    
    const startScreen = document.getElementById("startScreen");
    if (startScreen) {
      startScreenObserver.observe(startScreen, {
        attributes: true,
        attributeFilter: ['style']
      });
    }

    // Start Game Button Logic
    const startButton = document.getElementById("startButton");
    if (startButton) {
        startButton.addEventListener("click", () => {
        if (!isLoggedIn()) {
          alert("Please log in to continue playing");
          return;
        }
        const startScreen = document.getElementById("startScreen");
        if (startScreen) {
            startScreen.style.display = "none";
            updatePortalButton(); // Update button when game starts
        }

        // Load Level 1 and force play mode
        if (typeof LEVELS !== 'undefined' && LEVELS.length > 0) {
            loadPuzzle(LEVELS[0]);

            // Just to be sure everything initializes:
            if (typeof enablePlayerControls === "function") {
            enablePlayerControls();
            }
        }
        });
    }
    });
  </script>
  
  <!-- Link to external JS -->
  <script src="js/game.js"></script>
  <script src="js/levels.js"></script>

  <audio id="bgMusic" loop preload="auto">
    <source src="assets/audio/background1.mp3" type="audio/mpeg">
  </audio>

  <audio id="moveSound" preload="auto">
    <source src="assets/audio/thump.mp3" type="audio/mpeg">
  </audio>

  <audio id="explosionSound" preload="auto">
    <source src="assets/audio/explosion.mp3" type="audio/mpeg">
  </audio>


  <button id="restartLevelBtn" style="
    position: fixed;
    bottom: 20px;
    right: 140px; /* ‚úÖ increased to make space for the other button */
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    background: #e74c3c;
    color: white;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    z-index: 9999;
  ">
    üîÅ Restart Level</button>

  <button id="musicToggle" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    background: #3498db;
    color: white;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    z-index: 9999;
  ">üîä Music</button>

  <button onclick="toggleAntigravity()" style="
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 1000;
    padding: 10px 15px;
    font-weight: bold;
    background-color: #e67e22;
    color: white;
    border: none;
    border-radius: 8px;
    box-shadow: 2px 2px 10px rgba(0,0,0,0.3);
    cursor: pointer;
  ">
    ‚¨ÜÔ∏è Antigravity</button>

</body>
</html>